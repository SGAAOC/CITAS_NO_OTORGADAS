<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CITAS NO OTORGADAS</title>
<style>
  :root{
    --blue:#0077c8;
    --blue-dark:#005c99;
    --light:#f5fbff;
    --border:#b4c9e7;
    --success:#28a745;
    --success-light:#e8f5e9;
    --error:#e74c3c;
    --error-light:#fef6f6;
    --warning:#ffeb3b;
    --warning-dark:#f2b400;
    --focus:#4fc3f7;
    --card-bg:#fff;
  }
  *{box-sizing:border-box}
  body{
    font-family: Arial, sans-serif;
    background: linear-gradient(180deg,#e8f1fb,#f8fbff);
    margin:0;
    padding:20px;
    display:flex;
    justify-content:center;
  }
  .wrapper{ width:100%; max-width:880px; }
  header{ text-align:center; margin-bottom:14px; }
  header h1{
    background:var(--blue);
    color:white;
    margin:0;
    padding:14px 18px;
    border-radius:8px;
    letter-spacing:0.6px;
    font-size:20px;
  }
  .card{
    background: var(--card-bg);
    border-radius:10px;
    box-shadow:0 6px 24px rgba(0,0,0,0.08);
    padding:18px;
    border-top:6px solid var(--blue);
  }
  label{ display:block; margin-top:12px; font-weight:700; color:#003b6f; }
  input, select, textarea, .registro {
    width:100%;
    padding:10px;
    margin-top:6px;
    border-radius:8px;
    border:2px solid var(--border);
    font-size:14px;
    text-transform:uppercase;
    background:white;
    transition: all 0.25s ease;
  }
  .registro{
    text-align:center;
    background:var(--light);
    font-weight:700;
    color:var(--blue);
    font-size:15px;
    position: relative;
    padding-left:28px;
  }
  .registro::before {
    content: "üïí";
    position: absolute;
    left: 8px;
    top: 50%;
    transform: translateY(-50%);
    animation: rotateClock 20s linear infinite;
  }
  @keyframes rotateClock {
    from { transform: translateY(-50%) rotate(0deg); }
    to { transform: translateY(-50%) rotate(360deg); }
  }
  .row{ display:flex; gap:12px; align-items:flex-end; margin-top:6px; }
  .col{ flex:1; }
  .small-btn{
    display:inline-block;
    margin-top:8px;
    padding:6px 10px;
    border-radius:6px;
    font-size:12px;
    cursor:pointer;
    border:none;
    transition: all 0.2s ease;
  }
  .small-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 6px rgba(0,0,0,0.12);
  }
  .fixed{ background:var(--blue); color:white; }
  .notfixed{ background:var(--border); color:#073a6a; }
  .fijado-label{ font-size:12px; color:var(--blue); margin-top:6px; font-weight:700; display:none; }
  .fijado-visible{ display:block; }
  .check{ color:var(--success); font-size:18px; margin-left:8px; display:none; vertical-align:middle;}
  .check.visible{ 
    display:inline-block; 
    animation: pop .28s ease-out, bounce 0.6s 0.2s ease;
  }
  @keyframes pop{ from{transform:scale(0);} to{transform:scale(1);} }
  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-4px); }
  }
  .btns{ display:flex; gap:10px; margin-top:12px; }
  .btn{ 
    flex:1; 
    padding:10px; 
    background:var(--blue); 
    color:white; 
    border:none; 
    border-radius:8px; 
    font-weight:700; 
    cursor:pointer; 
    position: relative;
    overflow: hidden;
    transition: all 0.2s ease;
  }
  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,59,111,0.25);
  }
  .btn.secondary{ background:var(--blue-dark); }
  textarea{ 
    min-height:72px; 
    resize:vertical; 
    text-transform:uppercase;
    transition: all 0.2s ease;
  }
  textarea:focus {
    box-shadow: 0 0 0 2px var(--focus) !important;
  }
  .note{ font-size:12px; color:#456; margin-top:6px; }

  /* ‚úÖ ESTILOS MEJORADOS */
  input:focus, select:focus {
    border-color: var(--focus) !important;
    box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.3) !important;
    outline: none;
  }

  .success {
    border-color: var(--success) !important;
    background-color: var(--success-light) !important;
    box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.15) !important;
    animation: pulseSuccess 0.6s ease-out;
  }
  @keyframes pulseSuccess {
    0% { box-shadow: 0 0 0 0 rgba(40,167,69,0.4); }
    70% { box-shadow: 0 0 0 8px rgba(40,167,69,0); }
    100% { box-shadow: 0 0 0 0 rgba(40,167,69,0); }
  }

  .incomplete {
    border-color: var(--warning-dark) !important;
    background-color: rgba(255, 235, 59, 0.08) !important;
    box-shadow: 0 0 0 2px rgba(242, 180, 0, 0.1) !important;
  }

  .error-field {
    border-color: var(--error) !important;
    background-color: var(--error-light) !important;
    box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.15) !important;
  }

  .status-msg {
    font-size: 11px;
    margin-top: 4px;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: 600;
    display: inline-block;
    animation: fadeIn 0.3s ease-out;
  }
  .status-msg.success { background: var(--success-light); color: var(--success); }
  .status-msg.warning { background: rgba(255, 235, 59, 0.2); color: var(--warning-dark); }
  .status-msg.error { background: var(--error-light); color: var(--error); }
  @keyframes fadeIn { from { opacity:0; transform: translateY(-3px); } to { opacity:1; transform: translateY(0); } }

  .status-msg::before {
    margin-right: 4px;
    font-weight: bold;
  }
  .status-msg.success::before { content: "‚úî"; }
  .status-msg.warning::before { content: "‚ö†"; }
  .status-msg.error::before { content: "‚úò"; }

  /* üì§ Loader al guardar */
  .btn.loading {
    cursor: not-allowed;
    opacity: 0.8;
    position: relative;
  }
  .btn.loading::after {
    content: '';
    position: absolute;
    top: 50%; left: 50%;
    width: 16px; height: 16px;
    margin: -8px 0 0 -8px;
    border: 2px solid transparent;
    border-top-color: white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  @media (max-width:640px){ 
    .row{ flex-direction:column; } 
    .registro::before { animation: none; }
  }
</style>
</head>
<body>
<div class="wrapper">
  <header>
    <h1>DEMANDA DE CITAS NO OTORGADAS</h1>
  </header>

  <div class="card">

    <label>REGISTRO (Fecha y Hora)</label>
    <div id="registro" class="registro" aria-live="polite"></div>

    <div class="row" style="margin-top:10px;">
      <div class="col">
        <label>AGENTE *</label>
        <select id="agente">
          <option value="">Seleccione un agente...</option>
          <option value="AGUILAR ROJAS MAR√çA">AGUILAR ROJAS MAR√çA</option>
          <option value="BENITES QUISPE JUAN">BENITES QUISPE JUAN</option>
          <option value="CARDENAS FLORES LUISA">CARDENAS FLORES LUISA</option>
          <option value="DIAZ VARGAS CARLOS">DIAZ VARGAS CARLOS</option>
          <option value="ESPINOZA TORRES ROSA">ESPINOZA TORRES ROSA</option>
          <option value="FLORES MENDOZA PEDRO">FLORES MENDOZA PEDRO</option>
          <option value="GOMEZ RAM√çREZ ANA">GOMEZ RAM√çREZ ANA</option>
          <option value="HUAMAN SANCHEZ EDUARDO">HUAMAN SANCHEZ EDUARDO</option>
          <option value="IBA√ëEZ ORTIZ CLAUDIA">IBA√ëEZ ORTIZ CLAUDIA</option>
          <option value="JIM√âNEZ QUISPE MIGUEL">JIM√âNEZ QUISPE MIGUEL</option>
        </select>
        <div id="agente_fijado" class="fijado-label">üîí FIJADO</div>
        <div style="margin-top:6px;">
          <button id="fixAgente" class="small-btn notfixed">FIJAR</button>
          <button id="unfixAgente" class="small-btn notfixed" style="margin-left:6px;">NO FIJAR</button>
          <span id="checkAgente" class="check">‚úî</span>
        </div>
      </div>
      <div class="col">
        <label>SUPERVISOR *</label>
        <select id="supervisor">
          <option value="">Seleccione un supervisor...</option>
          <option value="ALARCON VEGA JORGE">ALARCON VEGA JORGE</option>
          <option value="BARRIENTOS MEJIA KARINA">BARRIENTOS MEJIA KARINA</option>
          <option value="CASTRO NAVARRO RICARDO">CASTRO NAVARRO RICARDO</option>
          <option value="DELGADO CUELLAR VERONICA">DELGADO CUELLAR VERONICA</option>
          <option value="ESCOBAR MIRANDA FERNANDO">ESCOBAR MIRANDA FERNANDO</option>
          <option value="FERNANDEZ RUIZ GLORIA">FERNANDEZ RUIZ GLORIA</option>
        </select>
        <div id="supervisor_fijado" class="fijado-label">üîí FIJADO</div>
        <div style="margin-top:6px;">
          <button id="fixSupervisor" class="small-btn notfixed">FIJAR</button>
          <button id="unfixSupervisor" class="small-btn notfixed" style="margin-left:6px;">NO FIJAR</button>
          <span id="checkSupervisor" class="check">‚úî</span>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>TIPO DE DOCUMENTO *</label>
        <select id="tipoDoc">
          <option value="">Seleccione tipo...</option>
          <option value="DNI">DNI</option>
          <option value="CE">CE</option>
          <option value="CEDULA">CEDULA</option>
          <option value="PASS">PASS</option>
        </select>
      </div>
      <div class="col">
        <label>N¬∞ DOCUMENTO *</label>
        <input id="dni" type="text" placeholder="Ingrese n√∫mero de documento" maxlength="8" inputmode="numeric" />
        <span id="checkDni" class="check">‚úî</span>
      </div>
    </div>

    <label>APELLIDOS Y NOMBRES *</label>
    <input id="nombres" type="text" readonly placeholder="Se autocompleta con DNI (si existe)" />
    <span id="checkNombres" class="check">‚úî</span>

    <div class="row">
      <div class="col">
        <label>FECHA DE NACIMIENTO *</label>
        <input id="fechaNacimiento" type="date" />
        <span id="checkFechaNacimiento" class="check">‚úî</span>
      </div>
      <div class="col">
        <label>SEXO *</label>
        <select id="sexo">
          <option value="">Seleccione</option>
          <option value="MASCULINO">MASCULINO</option>
          <option value="FEMENINO">FEMENINO</option>
        </select>
        <span id="checkSexo" class="check">‚úî</span>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>IPRESS *</label>
        <select id="ipress" required>
          <option value="">Seleccione IPRESS...</option>
          <option value="C.M. ANCIJE">C.M. ANCIJE</option>
          <option value="C.M. MALA">C.M. MALA</option>
          <option value="CAP II CHANCAY">CAP II CHANCAY</option>
          <option value="CAP II LUR√çN">CAP II LUR√çN</option>
          <option value="CAP III ALFREDO PIAZZA ROBERTS">CAP III ALFREDO PIAZZA ROBERTS</option>
          <option value="CAP III CARABAYLLO">CAP III CARABAYLLO</option>
          <option value="CAP III EL AGUSTINO">CAP III EL AGUSTINO</option>
          <option value="CAP III HNA. MARIA DONROSE SUTMOLLER">CAP III HNA. MARIA DONROSE SUTMOLLER</option>
          <option value="CAP III HUARAL">CAP III HUARAL</option>
          <option value="CAP III HUAYCAN">CAP III HUAYCAN</option>
          <option value="CAP III INDEPENDENCIA">CAP III INDEPENDENCIA</option>
          <option value="CAP III LUIS NEGREIROS VEGA">CAP III LUIS NEGREIROS VEGA</option>
          <option value="CAP III METROPOLITANO CALLAO">CAP III METROPOLITANO CALLAO</option>
          <option value="CAP III PEDRO REYES BARBOZA">CAP III PEDRO REYES BARBOZA</option>
          <option value="CAP III PUENTE PIEDRA">CAP III PUENTE PIEDRA</option>
          <option value="CAP III SAN ISIDRO">CAP III SAN ISIDRO</option>
          <option value="CAP III SAN JUAN DE MIRAFLORES">CAP III SAN JUAN DE MIRAFLORES</option>
          <option value="CAP III SURQUILLO">CAP III SURQUILLO</option>
          <option value="H.I AURELIO DIAZ-UFANO Y PERAL">H.I AURELIO DIAZ-UFANO Y PERAL</option>
          <option value="H.I CARLOS ALCANTARA BUTTERFIELD">H.I CARLOS ALCANTARA BUTTERFIELD</option>
          <option value="H.I JORGE VOTO BERNALES CORPANCHO">H.I JORGE VOTO BERNALES CORPANCHO</option>
          <option value="H.I MARINO MOLINA SCIPPA">H.I MARINO MOLINA SCIPPA</option>
          <option value="H.I OCTAVIO MONGRUT MU√ëOZ">H.I OCTAVIO MONGRUT MU√ëOZ</option>
          <option value="H.I ULDARICO ROCCA FERNANDEZ">H.I ULDARICO ROCCA FERNANDEZ</option>
          <option value="H.II CA√ëETE">H.II CA√ëETE</option>
          <option value="H.II GUSTAVO LANATTA LUJAN">H.II GUSTAVO LANATTA LUJAN</option>
          <option value="H.II LIMA NORTE - CALLAO L. NEGREIROS V.">H.II LIMA NORTE - CALLAO L. NEGREIROS V.</option>
          <option value="H.II RAMON CASTILLA">H.II RAMON CASTILLA</option>
          <option value="H.II VITARTE">H.II VITARTE</option>
          <option value="H.III HOSPITAL DE EMERGENCIAS GRAU">H.III HOSPITAL DE EMERGENCIAS GRAU</option>
          <option value="H.III SUAREZ-ANGAMOS">H.III SUAREZ-ANGAMOS</option>
          <option value="H.N. ALBERTO SABOGAL SOLOGUREN">H.N. ALBERTO SABOGAL SOLOGUREN</option>
          <option value="H.N. EDGARDO REBAGLIATI MARTINS">H.N. EDGARDO REBAGLIATI MARTINS</option>
          <option value="IPRESS CLINICA SAN BARTOLOME - HUACHO">IPRESS CLINICA SAN BARTOLOME - HUACHO</option>
          <option value="IPRESS CLINICA SAN PEDRO">IPRESS CLINICA SAN PEDRO</option>
          <option value="IPRESS SAN MARTIN DE PORRES">IPRESS SAN MARTIN DE PORRES</option>
          <option value="POL. CHINCHA">POL. CHINCHA</option>
          <option value="POL. CHOSICA">POL. CHOSICA</option>
          <option value="POL. COMPLEJIDAD CRECIENTE SAN NICOLAS">POL. COMPLEJIDAD CRECIENTE SAN NICOLAS</option>
          <option value="POL. FIORI">POL. FIORI</option>
          <option value="POL. FRANCISCO PIZARRO">POL. FRANCISCO PIZARRO</option>
          <option value="POL. JUAN JOSE RODRIGUEZ LAZO">POL. JUAN JOSE RODRIGUEZ LAZO</option>
          <option value="POL. PABLO BERMUDEZ">POL. PABLO BERMUDEZ</option>
          <option value="POL. PROCERES">POL. PROCERES</option>
          <option value="POL. SAN LUIS">POL. SAN LUIS</option>
          <option value="POL. SANTA CRUZ">POL. SANTA CRUZ</option>
          <option value="POLICLINICO BAYOVAR">POLICLINICO BAYOVAR</option>
          <option value="POLICLINICO SAN CARLOS">POLICLINICO SAN CARLOS</option>
          <option value="RETABLO - COMAS">RETABLO - COMAS</option>
        </select>
        <span id="checkIpress" class="check">‚úî</span>
      </div>
      <div class="col">
        <label>ESPECIALIDAD *</label>
        <select id="espe">
          <option value="">Seleccione especialidad...</option>
          <option value="MEDICINA GENERAL">MEDICINA GENERAL</option>
          <option value="PEDIATR√çA">PEDIATR√çA</option>
          <option value="GINECOLOG√çA Y OBSTETRICIA">GINECOLOG√çA Y OBSTETRICIA</option>
          <option value="CARDIOLOG√çA">CARDIOLOG√çA</option>
          <option value="NEUROLOG√çA">NEUROLOG√çA</option>
          <option value="PSIQUIATR√çA">PSIQUIATR√çA</option>
          <option value="TRAUMATOLOG√çA">TRAUMATOLOG√çA</option>
          <option value="DERMATOLOG√çA">DERMATOLOG√çA</option>
          <option value="ENDOCRINOLOG√çA">ENDOCRINOLOG√çA</option>
          <option value="NEFROLOG√çA">NEFROLOG√çA</option>
          <option value="ONCOLOG√çA">ONCOLOG√çA</option>
          <option value="OFTALMOLOG√çA">OFTALMOLOG√çA</option>
          <option value="OTORRINOLARINGOLOG√çA">OTORRINOLARINGOLOG√çA</option>
          <option value="UROLOG√çA">UROLOG√çA</option>
          <option value="OTRA">OTRA</option>
        </select>
        <span id="checkEspe" class="check">‚úî</span>
      </div>
    </div>

    <label>OBSERVACI√ìN * <small style="font-weight:normal;color:#777;">(*) obligatorio</small></label>
    <select id="obsSelect">
      <option value="">Seleccione motivo...</option>
      <option value="HISTORIA CLINICA BLOQUEADA">HISTORIA CLINICA BLOQUEADA</option>
      <option value="NO CUENTA CON VIGENCIA DE ATENCI√ìN">NO CUENTA CON VIGENCIA DE ATENCI√ìN</option>
      <option value="NO SE CUENTA CON CITAS DISPONIBLES">NO SE CUENTA CON CITAS DISPONIBLES</option>
      <option value="NO SE CUENTA CON PROGRAMACI√ìN DISPONIBLE">NO SE CUENTA CON PROGRAMACI√ìN DISPONIBLE</option>
      <option value="EEL NO OTORGA CITAS A PACIENTES REFERIDOS">EEL NO OTORGA CITAS A PACIENTES REFERIDOS</option>
      <option value="EEL NO OTORGA CITAS DE ESPECIALIDADES EN ALGUNAS IPRESS">EEL NO OTORGA CITAS DE ESPECIALIDADES EN ALGUNAS IPRESS</option>
      <option value="NO HAY CITAS DISPONIBLES DE TELECONSULTA">NO HAY CITAS DISPONIBLES DE TELECONSULTA</option>
      <option value="PACIENTE ADSCRITO A PROVINCIA">PACIENTE ADSCRITO A PROVINCIA</option>

    </select>
    <textarea id="obs" placeholder="Detalles adicionales (si aplica)..." style="margin-top:6px;display:none;"></textarea>
    <span id="checkObs" class="check">‚úî</span>

    <div class="row">
      <div class="col">
        <label>CELULAR 1 *</label>
        <input id="cel1" type="tel" placeholder="Ej: 987654321" maxlength="9" inputmode="numeric" />
        <span id="checkCel1" class="check">‚úî</span>
      </div>
      <div class="col">
        <label>CELULAR 2 (CONTINGENCIA)</label>
        <input id="cel2" type="tel" placeholder="Opcional" maxlength="9" inputmode="numeric" />
        <span id="checkCel2" class="check">‚úî</span>
      </div>
    </div>

    <div class="btns">
      <button class="btn secondary" id="btnNuevo">NUEVO REGISTRO</button>
      <button class="btn" id="btnGuardar">GUARDAR</button>
    </div>

    <p class="note">‚úÖ Todos los campos con * son obligatorios. Datos se env√≠an a Google Sheets.</p>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);

// üîë TU URL DE GOOGLE APPS SCRIPT ‚Äî YA CONFIGURADA
const SHEETS_URL = "https://script.google.com/macros/s/AKfycbx9Zjjr3Jp-P-K0dJ2HNq0FowC5uEdQixxIGiQ6YWRbB30WHrqa8YPd8OaVDKNhgyZU/exec";

/* Mostrar/Ocultar textarea seg√∫n selecci√≥n de observaci√≥n */
$('obsSelect').addEventListener('change', function(){
  const textarea = $('obs');
  if(this.value === 'OTRO'){
    textarea.style.display = 'block';
    textarea.focus();
  } else {
    textarea.style.display = 'none';
    textarea.value = '';
  }
});

/* Fecha / hora */
function formatoAmigable(date){
  const opts = { weekday:'long', day:'2-digit', month:'long',
                hour:'2-digit', minute:'2-digit', second:'2-digit',
                hour12:false, timeZone:'America/Lima' };
  const texto = date.toLocaleString('es-PE', opts);
  return texto.charAt(0).toUpperCase() + texto.slice(1);
}
function actualizarRegistro(){ $('registro').innerText = formatoAmigable(new Date()); }
setInterval(actualizarRegistro,1000);
actualizarRegistro();

/* ‚úÖ Fijar / no fijar + animaci√≥n pulse */
function applyFijadoVisual(id, isFixed){
  const input = $(id);
  const fijadoLabel = $(id + '_fijado');
  const btnCheck = $('check' + capitalizeId(id));
  const fixBtn = (id === 'agente') ? $('fixAgente') : $('fixSupervisor');
  const unfixBtn = (id === 'agente') ? $('unfixAgente') : $('unfixSupervisor');
  if(isFixed){
    fijadoLabel.classList.add('fijado-visible');
    fixBtn.classList.remove('notfixed'); fixBtn.classList.add('fixed');
    unfixBtn.classList.remove('fixed'); unfixBtn.classList.add('notfixed');
    btnCheck.classList.add('visible');
    input.style.animation = 'pulseSuccess 0.4s, bounce 0.6s 0.2s ease';
    setTimeout(() => input.style.animation = '', 1000);
  } else {
    fijadoLabel.classList.remove('fijado-visible');
    fixBtn.classList.remove('fixed'); fixBtn.classList.add('notfixed');
    unfixBtn.classList.remove('notfixed');
    btnCheck.classList.remove('visible');
  }
}
function capitalizeId(id){ return id.charAt(0).toUpperCase() + id.slice(1); }
function fijarCampo(id,key){ 
  const val=$(id).value.trim(); 
  if(!val){ 
    alert('Seleccione un valor antes de fijar.'); 
    return; 
  } 
  localStorage.setItem(key,val); 
  applyFijadoVisual(id,true); 
}
function nofijarCampo(id,key){ 
  localStorage.removeItem(key); 
  applyFijadoVisual(id,false); 
}
$('fixAgente').addEventListener('click', ()=> fijarCampo('agente','AGENTE'));
$('unfixAgente').addEventListener('click', ()=> nofijarCampo('agente','AGENTE'));
$('fixSupervisor').addEventListener('click', ()=> fijarCampo('supervisor','SUPERVISOR'));
$('unfixSupervisor').addEventListener('click', ()=> nofijarCampo('supervisor','SUPERVISOR'));

window.addEventListener('load',()=>{
  const ag=localStorage.getItem('AGENTE'); 
  const sp=localStorage.getItem('SUPERVISOR');
  if(ag){ 
    $('agente').value=ag; 
    applyFijadoVisual('agente',true);
  }
  if(sp){ 
    $('supervisor').value=sp; 
    applyFijadoVisual('supervisor',true);
  }
});

/* ‚úÖ Funciones de estado visual */
function showStatusMsg(input, text, type) {
  const prev = input.nextElementSibling;
  if(prev && prev.classList.contains('status-msg')) prev.remove();
  const span = document.createElement('span');
  span.className = `status-msg ${type}`;
  span.textContent = text;
  input.parentNode.insertBefore(span, input.nextSibling);
}

function showSuccessField(inputId, msg = "‚úî Listo") {
  const input = $(inputId);
  if(!input) return;
  input.classList.remove('error-field', 'incomplete');
  input.classList.add('success');
  showStatusMsg(input, msg, 'success');
  setTimeout(() => input.classList.remove('success'), 1500);
}

function showWarningField(inputId, msg = "‚ö† Incompleto") {
  const input = $(inputId);
  if(!input) return;
  input.classList.remove('success', 'error-field');
  input.classList.add('incomplete');
  showStatusMsg(input, msg, 'warning');
}

function showErrorField(inputId, msg = "‚úò Inv√°lido") {
  const input = $(inputId);
  if(!input) return;
  input.classList.remove('success', 'incomplete');
  input.classList.add('error-field');
  showStatusMsg(input, msg, 'error');
}

function clearFieldStatus(inputId) {
  const input = $(inputId);
  if(!input) return;
  input.classList.remove('success', 'incomplete', 'error-field');
  const msg = input.nextElementSibling;
  if(msg && msg.classList.contains('status-msg')) msg.remove();
}

/* DNI */
$('dni').addEventListener('input', function(){
  this.value = this.value.replace(/\D/g, '').slice(0,8);
});
$('dni').addEventListener('blur', function(){
  const val = this.value.trim();
  if(val && val.length === 8) {
    this.value = val.padStart(8, '0');
    clearFieldStatus('dni');
  } else if(val) {
    showWarningField('dni', '‚ö† Ingrese 8 d√≠gitos');
  }
});

/* Buscar DNI */
async function buscarDNI(dni){
  const url = `http://172.20.60.152:8000/buscar/${encodeURIComponent(dni)}`;
  try{
    const resp = await fetch(url, { timeout: 5000 });
    if(!resp.ok){ 
      $('nombres').value = ''; 
      $('nombres').readOnly = false;
      return; 
    }
    const data = await resp.json();

    const normalize = obj => {
      const keys = {};
      for(let k in obj) keys[k.toLowerCase()] = obj[k];
      return keys;
    };
    const d = normalize(data);

    const nombreCompleto = d.nombre_completo || d.apellidos_nombres || 
      (d.apellido_paterno && d.apellido_materno && d.nombres 
        ? `${d.apellido_paterno} ${d.apellido_materno} ${d.nombres}` : null) || null;
    $('nombres').value = nombreCompleto ? String(nombreCompleto).toUpperCase() : '';
    $('nombres').readOnly = !!nombreCompleto;

    let fechaNac = d.fecha_nacimiento || d.fecha_nac || d.fechanac;
    if(fechaNac && typeof fechaNac === 'string'){
      const parts = fechaNac.split(/[\/\-]/);
      if(parts.length === 3){
        const [d,m,y] = parts[0].length <= 2 ? [parts[0], parts[1], parts[2]] : [parts[2], parts[1], parts[0]];
        if(y && m && d) {
          fechaNac = `${y.padStart(4,'0')}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
          $('fechaNacimiento').value = fechaNac;
          showSuccessField('fechaNacimiento', '‚úî Fecha cargada');
        }
      }
    }

    const sexoVal = d.sexo || d.genero || '';
    if(/masculino|m/i.test(String(sexoVal))) {
      $('sexo').value = 'MASCULINO';
      showSuccessField('sexo', '‚úî Sexo cargado');
    } else if(/femenino|f/i.test(String(sexoVal))) {
      $('sexo').value = 'FEMENINO';
      showSuccessField('sexo', '‚úî Sexo cargado');
    }

    if(nombreCompleto) {
      showSuccessField('nombres', '‚úî Nombre cargado');
    }
    $('checkDni').classList.add('visible');
    setTimeout(() => $('checkDni').classList.remove('visible'), 2000);

  }catch(err){ 
    $('nombres').value = '';
    $('nombres').readOnly = false;
    $('fechaNacimiento').value = '';
    $('sexo').value = '';
  }
}

let debounce;
$('dni').addEventListener('input', function(){
  clearTimeout(debounce);
  const val = this.value.trim();
  if(val.length >= 7){ 
    debounce = setTimeout(()=>buscarDNI(val.padStart(8,'0')), 450);
  } else {
    $('nombres').value = '';
    $('nombres').readOnly = false;
    $('fechaNacimiento').value = '';
    $('sexo').value = '';
    ['nombres','fechaNacimiento','sexo'].forEach(id => clearFieldStatus(id));
  }
});
$('dni').addEventListener('keydown',(e)=>{ 
  if(e.key==='Enter'){ 
    e.preventDefault(); 
    const dni = $('dni').value.trim();
    if(dni && dni.length === 8) {
      buscarDNI(dni.padStart(8,'0'));
    } else {
      showWarningField('dni', '‚ö† Ingrese 8 d√≠gitos');
    }
  } 
});

// Celulares
function validarCelular(inputId, checkId) {
  const input = $(inputId);
  const val = input.value.replace(/\D/g, '').slice(0,9);
  input.value = val;
  if(val.length >= 7 && /^\d{7,9}$/.test(val)){
    showSuccessField(inputId, '‚úî Celular v√°lido');
    const chk = $(checkId);
    chk.classList.add('visible');
    setTimeout(() => chk.classList.remove('visible'), 2000);
  }
}
$('cel1').addEventListener('input', () => validarCelular('cel1', 'checkCel1'));
$('cel2').addEventListener('input', () => validarCelular('cel2', 'checkCel2'));

// Nuevo registro
$('btnNuevo').addEventListener('click',function(e){ 
  e.preventDefault();
  const agF = localStorage.getItem('AGENTE');
  const spF = localStorage.getItem('SUPERVISOR');
  
  ['dni','nombres','fechaNacimiento','sexo','ipress','espe','obsSelect','obs','cel1','cel2'].forEach(id=>{
    const el = $(id);
    if(el) {
      if(el.tagName === 'SELECT') {
        el.selectedIndex = 0;
        if(id === 'obsSelect') $('obs').style.display = 'none';
      } else {
        el.value = '';
      }
    }
  });
  
  if(agF) $('agente').value = agF;
  if(spF) $('supervisor').value = spF;
  
  document.querySelectorAll('.status-msg').forEach(el => el.remove());
  document.querySelectorAll('input, select').forEach(el => {
    el.classList.remove('success', 'incomplete', 'error-field');
  });
  actualizarRegistro(); 
});

// ‚úÖ VALIDACI√ìN FINAL: TODOS OBLIGATORIOS EXCEPTO CELULAR 2
function validateForm() {
  const checks = [
    {id: 'agente', valid: v => v.trim(), msg: 'Agente obligatorio'},
    {id: 'supervisor', valid: v => v.trim(), msg: 'Supervisor obligatorio'},
    {id: 'tipoDoc', valid: v => v.trim(), msg: 'Tipo de documento obligatorio'},
    {id: 'dni', valid: v => v.trim().length === 8, msg: 'DNI: 8 d√≠gitos'},
    {id: 'nombres', valid: v => v.trim(), msg: 'Nombre obligatorio'},
    {id: 'fechaNacimiento', valid: v => v.trim(), msg: 'Fecha de nacimiento obligatoria'},
    {id: 'sexo', valid: v => v.trim(), msg: 'Sexo obligatorio'},
    {id: 'ipress', valid: v => v.trim(), msg: 'IPRESS obligatoria'},
    {id: 'espe', valid: v => v.trim(), msg: 'Especialidad obligatoria'},
    {id: 'obsSelect', valid: v => v.trim(), msg: 'Motivo de observaci√≥n obligatorio'}
  ];

  let firstError = null;

  checks.forEach(({id, valid, msg}) => {
    const el = $(id);
    const val = el ? el.value : '';
    if(el && !valid(val)) {
      showErrorField(id, `‚úò ${msg}`);
      if(!firstError) firstError = el;
    } else if(el) {
      clearFieldStatus(id);
    }
  });

  const obsSelect = $('obsSelect');
  const obsTextarea = $('obs');
  if (obsSelect.value === 'OTRO') {
    const obsVal = obsTextarea.value.trim();
    if (!obsVal) {
      showErrorField('obs', '‚úò Detalle obligatorio (motivo: OTRO)');
      if (!firstError) firstError = obsTextarea;
    } else {
      clearFieldStatus('obs');
    }
  } else {
    clearFieldStatus('obs');
  }

  const cel1Val = $('cel1').value.replace(/\D/g, '');
  if (!/^\d{7,9}$/.test(cel1Val)) {
    showErrorField('cel1', '‚úò CELULAR 1: 7-9 d√≠gitos');
    if (!firstError) firstError = $('cel1');
  } else {
    clearFieldStatus('cel1');
  }

  if (firstError) {
    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
    setTimeout(() => firstError.focus(), 300);
  }

  return firstError;
}

// üì§ ENVIAR A GOOGLE SHEETS
async function enviarAGoogleSheets() {
  const data = {
    Agente: $('agente').value,
    Supervisor: $('supervisor').value,
    TipoDoc: $('tipoDoc').value,
    DNI: $('dni').value.padStart(8, '0'),
    Nombres: $('nombres').value,
    FechaNac: $('fechaNacimiento').value,
    Sexo: $('sexo').value,
    IPRESS: $('ipress').value,
    Especialidad: $('espe').value,
    Observacion: $('obsSelect').value,
    ObsDetalle: $('obs').value,
    Celular1: $('cel1').value,
    Celular2: $('cel2').value || ''
  };

  try {
    // Usa mode: 'no-cors' para evitar errores con Google
    const response = await fetch(SHEETS_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    // Como no-cors no devuelve respuesta, asumimos √©xito si no hay error de red
    return { success: true };
  } catch (err) {
    return { error: true, message: err.message };
  }
}

// Toast de √©xito/error
function showToast(message, isSuccess = true) {
  const color = isSuccess ? '#28a745' : '#e74c3c';
  const toast = document.createElement('div');
  toast.innerHTML = `
    <div style="
      position:fixed; top:20px; right:20px; 
      background:${color}; color:white; 
      padding:14px 24px; border-radius:8px; 
      box-shadow:0 6px 20px rgba(0,0,0,0.2);
      font-weight:700; z-index:10000;
      animation: slideIn 0.4s, fadeOut 0.4s 2.6s;
    ">
      ${isSuccess ? '‚úîÔ∏è' : '‚ùå'} ${message}
    </div>
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// Guardar + Enviar
$('btnGuardar').addEventListener('click', async function(e){
  e.preventDefault();

  document.querySelectorAll('.status-msg').forEach(el => el.remove());

  const firstError = validateForm();
  if(firstError) return;

  // üü° Activar estado de carga
  const btn = $('btnGuardar');
  btn.classList.add('loading');
  btn.disabled = true;

  // ‚ú® Mostrar √©xito local primero
  [
    'agente','supervisor','tipoDoc','dni','nombres','fechaNacimiento','sexo',
    'ipress','espe','obsSelect','cel1'
  ].forEach(id => showSuccessField(id, '‚úî Listo'));
  
  if($('obsSelect').value === 'OTRO') showSuccessField('obs', '‚úî Detalle agregado');
  if($('cel2').value.trim()) showSuccessField('cel2', '‚úî Listo');

  // üì§ Enviar a Google Sheets
  const result = await enviarAGoogleSheets();

  // üü¢/üî¥ Actualizar bot√≥n y mostrar resultado
  setTimeout(() => {
    btn.classList.remove('loading');
    btn.disabled = false;

    if (result.success) {
      showToast("Registro guardado en Google Sheets ‚úÖ");
      
      // Limpiar tras √©xito
      setTimeout(() => {
        const agF = localStorage.getItem('AGENTE');
        const spF = localStorage.getItem('SUPERVISOR');
        
        ['dni','nombres','fechaNacimiento','sexo','ipress','espe','obsSelect','cel1','cel2'].forEach(id=>{
          const el = $(id);
          if(el) {
            if(el.tagName === 'SELECT') el.selectedIndex = 0;
            else el.value = '';
          }
        });
        $('obs').value = '';
        $('obs').style.display = 'none';
        
        if(agF) $('agente').value = agF;
        if(spF) $('supervisor').value = spF;
        
        actualizarRegistro();
      }, 1200);
    } else {
      showErrorField('registro', '‚úò Error al enviar a Sheets');
      showToast("Error de red: " + (result.message || "Verifica conexi√≥n"), false);
    }
  }, 800);
});
</script>

</body>

</html>







